<!DOCTYPE html>
<html><head>
<meta name="google-site-verification" content="XrwF-xUZWSGJVBBm7jM8vqemVqx--zo5Tb9d-Vr7BCc" />
<title>保存sku、spu，feign遠程調用</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="SpringBoot微服務項目筆記-06">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">



<meta property="og:title" content="保存sku、spu，feign遠程調用" />
<meta property="og:description" content="SpringBoot微服務項目筆記-06" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yoziming.github.io/post/220123-gulimall-06-feign/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-01-23T00:00:00+00:00" /><meta property="og:site_name" content="My Blog" />






<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="保存sku、spu，feign遠程調用"/>
<meta name="twitter:description" content="SpringBoot微服務項目筆記-06"/>







<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  




<link rel="icon" href="https://yoziming.github.io/images/favicon.png">



<link rel="stylesheet" href="https://yoziming.github.io/scss/journal.min.3f72a5fc8f5b5dd732a4b476aced0eece2156958d9d414316494ddb10593ddf7.css" integrity="sha256-P3Kl/I9bXdcypLR2rO0O7OIVaVjZ1BQxZJTdsQWT3fc=" media="screen">



<link rel="stylesheet" href="https://yoziming.github.io/scss/dark-mode.min.f7c2efa7183435a6bd1842f91c541481c7a5137b5991629a870f24e4a516ad4b.css" integrity="sha256-98Lvpxg0Naa9GEL5HFQUgcelE3tZkWKahw8k5KUWrUs=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons");
</script>






  <script src="/js/toc.js"></script>











<script src="//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js"></script>





</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://yoziming.github.io/">
    
        <div class="nav-title">
            柚子茶室
        </div>
        
        <div class="nav-subtitle">
            紀錄自學大小事
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/">
                首頁🏠
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                系列文📖
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                標籤🏷️
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about-me">
                關於我🐣
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Yoziming
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- 目錄 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%8a%b7%e5%94%ae%e5%b1%ac%e6%80%a7" onclick="onNavClick(`#銷售屬性-nav`)" id="銷售屬性-nav">
									銷售屬性
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%86%e7%b5%84%e9%97%9c%e8%81%af" onclick="onNavClick(`#分組關聯-nav`)" id="分組關聯-nav">
									分組關聯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e7%a7%bb%e9%99%a4" onclick="onNavClick(`#移除-nav`)" id="移除-nav">
									移除
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%96%b0%e5%bb%ba%e9%97%9c%e8%81%af" onclick="onNavClick(`#新建關聯-nav`)" id="新建關聯-nav">
									新建關聯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bf%9d%e5%ad%98" onclick="onNavClick(`#保存-nav`)" id="保存-nav">
									保存
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%88%aa%e9%99%a4%e5%b1%ac%e6%80%a7%e6%99%82%e5%88%aa%e9%99%a4%e9%97%9c%e8%81%af" onclick="onNavClick(`#刪除屬性時刪除關聯-nav`)" id="刪除屬性時刪除關聯-nav">
									刪除屬性時刪除關聯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%96%b0%e5%a2%9e%e5%95%86%e5%93%81%e9%a0%81%e9%9d%a2" onclick="onNavClick(`#新增商品頁面-nav`)" id="新增商品頁面-nav">
									新增商品頁面
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%a0%b9%e6%93%9a%e5%88%86%e9%a1%9e%e8%bf%94%e5%9b%9e%e9%97%9c%e8%81%af%e7%9a%84%e5%93%81%e7%89%8c" onclick="onNavClick(`#根據分類返回關聯的品牌-nav`)" id="根據分類返回關聯的品牌-nav">
									根據分類返回關聯的品牌
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%8d%b2%e5%8f%96%e8%a6%8f%e6%a0%bc%e5%8f%83%e6%95%b8" onclick="onNavClick(`#獲取規格參數-nav`)" id="獲取規格參數-nav">
									獲取規格參數
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e4%bf%9d%e5%ad%98%e5%95%86%e5%93%81" onclick="onNavClick(`#保存商品-nav`)" id="保存商品-nav">
									保存商品
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%be%9ejson%e7%94%9f%e6%88%90pojo" onclick="onNavClick(`#從json生成pojo-nav`)" id="從json生成pojo-nav">
									從JSON生成POJO
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%96%8b%e5%a7%8b%e4%bf%9d%e5%ad%98" onclick="onNavClick(`#開始保存-nav`)" id="開始保存-nav">
									開始保存
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%81%a0%e7%a8%8b%e8%aa%bf%e7%94%a8feign" onclick="onNavClick(`#遠程調用feign-nav`)" id="遠程調用feign-nav">
									遠程調用feign
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#to%e9%a1%9e" onclick="onNavClick(`#to類-nav`)" id="to類-nav">
									To類
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%9f%a5%e8%ad%98%e9%bb%9e" onclick="onNavClick(`#知識點-nav`)" id="知識點-nav">
									知識點
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#debug%e5%b0%8f%e6%8a%80%e5%b7%a7" onclick="onNavClick(`#debug小技巧-nav`)" id="debug小技巧-nav">
									Debug小技巧
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/">
                    首頁🏠
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    系列文📖
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    標籤🏷️
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about-me">
                    關於我🐣
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目錄 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e9%8a%b7%e5%94%ae%e5%b1%ac%e6%80%a7" onclick="onNavClick(`#銷售屬性-nav`)" id="銷售屬性-nav">
									銷售屬性
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%86%e7%b5%84%e9%97%9c%e8%81%af" onclick="onNavClick(`#分組關聯-nav`)" id="分組關聯-nav">
									分組關聯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e7%a7%bb%e9%99%a4" onclick="onNavClick(`#移除-nav`)" id="移除-nav">
									移除
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%96%b0%e5%bb%ba%e9%97%9c%e8%81%af" onclick="onNavClick(`#新建關聯-nav`)" id="新建關聯-nav">
									新建關聯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e4%bf%9d%e5%ad%98" onclick="onNavClick(`#保存-nav`)" id="保存-nav">
									保存
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%88%aa%e9%99%a4%e5%b1%ac%e6%80%a7%e6%99%82%e5%88%aa%e9%99%a4%e9%97%9c%e8%81%af" onclick="onNavClick(`#刪除屬性時刪除關聯-nav`)" id="刪除屬性時刪除關聯-nav">
									刪除屬性時刪除關聯
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e6%96%b0%e5%a2%9e%e5%95%86%e5%93%81%e9%a0%81%e9%9d%a2" onclick="onNavClick(`#新增商品頁面-nav`)" id="新增商品頁面-nav">
									新增商品頁面
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e6%a0%b9%e6%93%9a%e5%88%86%e9%a1%9e%e8%bf%94%e5%9b%9e%e9%97%9c%e8%81%af%e7%9a%84%e5%93%81%e7%89%8c" onclick="onNavClick(`#根據分類返回關聯的品牌-nav`)" id="根據分類返回關聯的品牌-nav">
									根據分類返回關聯的品牌
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e7%8d%b2%e5%8f%96%e8%a6%8f%e6%a0%bc%e5%8f%83%e6%95%b8" onclick="onNavClick(`#獲取規格參數-nav`)" id="獲取規格參數-nav">
									獲取規格參數
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e4%bf%9d%e5%ad%98%e5%95%86%e5%93%81" onclick="onNavClick(`#保存商品-nav`)" id="保存商品-nav">
									保存商品
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%be%9ejson%e7%94%9f%e6%88%90pojo" onclick="onNavClick(`#從json生成pojo-nav`)" id="從json生成pojo-nav">
									從JSON生成POJO
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%96%8b%e5%a7%8b%e4%bf%9d%e5%ad%98" onclick="onNavClick(`#開始保存-nav`)" id="開始保存-nav">
									開始保存
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%81%a0%e7%a8%8b%e8%aa%bf%e7%94%a8feign" onclick="onNavClick(`#遠程調用feign-nav`)" id="遠程調用feign-nav">
									遠程調用feign
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#to%e9%a1%9e" onclick="onNavClick(`#to類-nav`)" id="to類-nav">
									To類
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e7%9f%a5%e8%ad%98%e9%bb%9e" onclick="onNavClick(`#知識點-nav`)" id="知識點-nav">
									知識點
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#debug%e5%b0%8f%e6%8a%80%e5%b7%a7" onclick="onNavClick(`#debug小技巧-nav`)" id="debug小技巧-nav">
									Debug小技巧
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://yoziming.github.io/">
            柚子茶室
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://yoziming.github.io/">
        <div class="single-column-header-title">柚子茶室</div>
        
        <div class="single-column-header-subtitle">紀錄自學大小事</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://yoziming.github.io/images/gulimall.png')"
                    
                
            >
                <div class="post-title">
                    保存sku、spu，feign遠程調用
                    
                    <div class="post-subtitle">
                        SpringBoot微服務項目筆記-06
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2022-01-23 00:00
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/java%E5%BE%AE%E6%9C%8D%E5%8B%99%E5%95%86%E5%9F%8E%E9%A0%85%E7%9B%AE">Java微服務商城項目</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/java">java</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="銷售屬性">銷售屬性</h2>
<ul>
<li>AttrController.java
<ul>
<li>獲取的API跟先前幾乎一樣，所以改造之前的<code>queryBasePageCatelogId</code>，順便換名字</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * 規格參數列表
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@GetMapping</span>(<span style="color:#cd5555">&#34;/{attrType}/list/{catelogId}&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#228b22">//@RequiresPermissions(&#34;product:attr:list&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">baseAttrList</span>(<span style="color:#707a7c">@RequestParam</span> Map&lt;String, Object&gt; params,
</span></span><span style="display:flex;"><span>                      <span style="color:#707a7c">@PathVariable</span>(<span style="color:#cd5555">&#34;catelogId&#34;</span>) Long catelogId,
</span></span><span style="display:flex;"><span>                      <span style="color:#707a7c">@PathVariable</span>(<span style="color:#cd5555">&#34;attrType&#34;</span>) String attrType
</span></span><span style="display:flex;"><span>) {
</span></span><span style="display:flex;"><span>    PageUtils page = attrService.<span style="color:#658b00">queryBaseAttrPage</span>(params, catelogId, attrType);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>().<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;page&#34;</span>, page);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>AttrServiceImpl.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> PageUtils <span style="color:#008b45">queryBaseAttrPage</span>(Map&lt;String, Object&gt; params, Long catelogId, String attrType) {
</span></span><span style="display:flex;"><span>    QueryWrapper&lt;AttrEntity&gt; qw = <span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 判斷是要銷售還是基本屬性，1=基本，0=銷售
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    qw.<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;attr_type&#34;</span>, <span style="color:#cd5555">&#34;base&#34;</span>.<span style="color:#658b00">equalsIgnoreCase</span>(attrType) ? 1 : 0);
</span></span></code></pre></div><ul>
<li>順便修改保存方法</li>
</ul>
<p><img src="image-20220115135346367.png" alt="image-20220115135346367"></p>
<ul>
<li>為了不留技術債(只有自己知道的神秘代號)，新增一個枚舉類來表示</li>
</ul>
<p><img src="image-20220115135826032.png" alt="image-20220115135826032"></p>
<ul>
<li>把剛剛用的1、0都換成<code>ProductConstant.ATTR_TYPE_BASE.getCode()</code></li>
<li>查詢、修改的方法也都判斷一下是基本屬性才往下做</li>
</ul>
<h2 id="分組關聯">分組關聯</h2>
<ul>
<li>接口API:</li>
</ul>
<p><img src="image-20220115203918492.png" alt="image-20220115203918492"></p>
<p><img src="image-20220115210834640.png" alt="image-20220115210834640"></p>
<ul>
<li>沒有多的屬性，可以直接用AttrEntity作為DATA返回</li>
<li>AttrGroupController.java
<ul>
<li>注意調用的是<code>attrService</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * 根據分組ID查找關聯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> *
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * @param attrgroupId
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * @return
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@GetMapping</span>(<span style="color:#cd5555">&#34;/{attrgroupId}/attr/relation&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">attrRelation</span>(<span style="color:#707a7c">@PathVariable</span>(<span style="color:#cd5555">&#34;attrgroupId&#34;</span>) Long attrgroupId) {
</span></span><span style="display:flex;"><span>    List&lt;AttrEntity&gt; entities = attrService.<span style="color:#658b00">getAttrRelation</span>(attrgroupId);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>().<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;data&#34;</span>, entities);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>AttrServiceImpl.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> List&lt;AttrEntity&gt; <span style="color:#008b45">getAttrRelation</span>(Long attrgroupId) {
</span></span><span style="display:flex;"><span>    List&lt;AttrAttrgroupRelationEntity&gt; relationEntities =
</span></span><span style="display:flex;"><span>            relationDao.<span style="color:#658b00">selectList</span>(<span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;().<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;attr_group_id&#34;</span>,
</span></span><span style="display:flex;"><span>                    attrgroupId));
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 收集出attrId
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;Long&gt; longList =
</span></span><span style="display:flex;"><span>            relationEntities.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(AttrAttrgroupRelationEntity::getAttrId).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (longList == <span style="color:#8b008b;font-weight:bold">null</span> || longList.<span style="color:#658b00">size</span>() == 0) {
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">listByIds</span>(longList);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h3 id="移除">移除</h3>
<blockquote>
<p>就剛剛上面圖，點開關連旁邊的移除</p>
</blockquote>
<ul>
<li>API:</li>
</ul>
<p><img src="image-20220115211206307.png" alt="image-20220115211206307"></p>
<ul>
<li>業務上為了保持前後端溝通少、整齊，造一個Vo來接</li>
</ul>
<p><img src="image-20220115211534509.png" alt="image-20220115211534509"></p>
<ul>
<li>AttrGroupController.java
<ul>
<li>參數由於是自訂的的類，在HTTP用JSON傳遞，切記要加@RequestBody</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * 删除
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@PostMapping</span>(<span style="color:#cd5555">&#34;/attr/relation/delete&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">delete</span>(<span style="color:#707a7c">@RequestBody</span> AttrGroupRelationVo[] vos) {
</span></span><span style="display:flex;"><span>    attrService.<span style="color:#658b00">deleteRelation</span>(vos);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>AttrServiceImpl.java
<ul>
<li>由於要批量刪除，造一個自訂的SQL <code>batchDelete</code>方法</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">deleteRelation</span>(AttrGroupRelationVo[] vos) {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 無情將VO再轉回來 哭R
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;AttrAttrgroupRelationEntity&gt; entities = Arrays.<span style="color:#658b00">stream</span>(vos).<span style="color:#658b00">map</span>(item -&gt; {
</span></span><span style="display:flex;"><span>        AttrAttrgroupRelationEntity relationEntity = <span style="color:#8b008b;font-weight:bold">new</span> AttrAttrgroupRelationEntity();
</span></span><span style="display:flex;"><span>        BeanUtils.<span style="color:#658b00">copyProperties</span>(item, relationEntity);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> relationEntity;
</span></span><span style="display:flex;"><span>    }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>    relationDao.<span style="color:#658b00">batchDelete</span>(entities);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>AttrAttrgroupRelationDao.java
<ul>
<li>莫忘記加@Param(&ldquo;entities&rdquo;)</li>
</ul>
</li>
</ul>
<p><img src="image-20220115213800121.png" alt="image-20220115213800121"></p>
<ul>
<li>AttrAttrgroupRelationDao.xml
<ul>
<li>動態SQL的寫法，foreach循環，間隔符號<code>&quot; OR &quot;</code>前後記得都要空格</li>
<li>寫xml的SQL特別小心拚錯誤</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">&lt;delete</span> <span style="color:#658b00">id=</span><span style="color:#cd5555">&#34;batchDelete&#34;</span><span style="color:#8b008b;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    DELETE
</span></span><span style="display:flex;"><span>    FROM pms_attr_attrgroup_relation WHERE
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&lt;foreach</span> <span style="color:#658b00">collection=</span><span style="color:#cd5555">&#34;entities&#34;</span> <span style="color:#658b00">item=</span><span style="color:#cd5555">&#34;item&#34;</span> <span style="color:#658b00">separator=</span><span style="color:#cd5555">&#34; OR &#34;</span><span style="color:#8b008b;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        attr_id = #{item.attrId} AND attr_group_id = #{item.attrGroupId}
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">&lt;/foreach&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">&lt;/delete&gt;</span>
</span></span></code></pre></div><h3 id="新建關聯">新建關聯</h3>
<blockquote>
<p>超級難點，套太多層了要想很久</p>
</blockquote>
<ul>
<li>先做新建時要跳出的可選項API: <code>/product/attrgroup/{attrgroupId}/noattr/relation</code></li>
</ul>
<p><img src="image-20220115215125341.png" alt="image-20220115215125341"></p>
<ul>
<li>AttrGroupController.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>	<span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     * 根據分組ID查找無關聯(新增時逆向篩選用)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@GetMapping</span>(<span style="color:#cd5555">&#34;/{attrgroupId}/noattr/relation&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">attrNoRelation</span>(<span style="color:#707a7c">@RequestParam</span> Map&lt;String, Object&gt; params,
</span></span><span style="display:flex;"><span>                        <span style="color:#707a7c">@PathVariable</span>(<span style="color:#cd5555">&#34;attrgroupId&#34;</span>) Long attrgroupId) {
</span></span><span style="display:flex;"><span>    PageUtils page = attrService.<span style="color:#658b00">getAttrNoRelation</span>(params, attrgroupId);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>().<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;page&#34;</span>, page);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>AttrServiceImpl.java
<ul>
<li>防空指針寫一堆not null，還以為在寫golang</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> PageUtils <span style="color:#008b45">getAttrNoRelation</span>(Map&lt;String, Object&gt; params, Long attrgroupId) {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 只查自己所屬分類中的屬性
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    AttrGroupEntity attrGroupEntity = attrGroupDao.<span style="color:#658b00">selectById</span>(attrgroupId);
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 獲取當前分類的id
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    Long catelogId = attrGroupEntity.<span style="color:#658b00">getCatelogId</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 只關連沒引用的屬性，這裡用排除法把已經被關聯的ID找出來，這是用來存排除的清單
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;Long&gt; alreadyInGroupIdList = <span style="color:#8b008b;font-weight:bold">new</span> ArrayList&lt;&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 先找出當前分類下的其他分組
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;AttrGroupEntity&gt; attr_groups = attrGroupDao.<span style="color:#658b00">selectList</span>(<span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;AttrGroupEntity&gt;().<span style="color:#658b00">eq</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#cd5555">&#34;catelog_id&#34;</span>
</span></span><span style="display:flex;"><span>            , catelogId));
</span></span><span style="display:flex;"><span>    List&lt;Long&gt; attr_group_ids =
</span></span><span style="display:flex;"><span>            attr_groups.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(AttrGroupEntity::getAttrGroupId).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 現在獲取到可能很多個attr_group_id，一個attr_group_id又會對應多個attr_id
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (attr_group_ids != <span style="color:#8b008b;font-weight:bold">null</span> &amp;&amp; attr_group_ids.<span style="color:#658b00">size</span>() &gt; 0) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 到pms_attr_attrgroup_relation，拿attr_group_id找出對應的relationEntities
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        List&lt;AttrAttrgroupRelationEntity&gt; relationEntities =
</span></span><span style="display:flex;"><span>                relationDao.<span style="color:#658b00">selectList</span>(<span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;().<span style="color:#658b00">in</span>(<span style="color:#cd5555">&#34;attr_group_id&#34;</span>,
</span></span><span style="display:flex;"><span>                        attr_group_ids));
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 這些relationEntities有attr_group_id，表示他的attr_id已經在某個分組內了
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (relationEntities != <span style="color:#8b008b;font-weight:bold">null</span> &amp;&amp; relationEntities.<span style="color:#658b00">size</span>() &gt; 0) {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 把其中的ID一個一個找出來，這些是要排除的
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            alreadyInGroupIdList =
</span></span><span style="display:flex;"><span>                    relationEntities.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(AttrAttrgroupRelationEntity::getAttrId).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 可以開查了
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    QueryWrapper&lt;AttrEntity&gt; queryWrapper = <span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;AttrEntity&gt;();
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 如果有要排除的
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">if</span> (alreadyInGroupIdList != <span style="color:#8b008b;font-weight:bold">null</span> &amp;&amp; alreadyInGroupIdList.<span style="color:#658b00">size</span>() &gt; 0) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 只查自己所屬分類中的屬性，移除掉要排除的，而且只要基本屬性
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        queryWrapper.<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;catelog_id&#34;</span>, catelogId).<span style="color:#658b00">notIn</span>(<span style="color:#cd5555">&#34;attr_id&#34;</span>, alreadyInGroupIdList).<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;attr_type&#34;</span>,
</span></span><span style="display:flex;"><span>                ProductConstant.<span style="color:#658b00">ATTR_TYPE_BASE</span>.<span style="color:#658b00">getCode</span>());
</span></span><span style="display:flex;"><span>    } <span style="color:#8b008b;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 只查自己所屬分類中的屬性，而且只要基本屬性
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        queryWrapper.<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;catelog_id&#34;</span>, catelogId).<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;attr_type&#34;</span>, ProductConstant.<span style="color:#658b00">ATTR_TYPE_BASE</span>.<span style="color:#658b00">getCode</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 前端要的是page，還可能要查key
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    String key = (String) params.<span style="color:#658b00">get</span>(<span style="color:#cd5555">&#34;key&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (!StringUtils.<span style="color:#658b00">isEmpty</span>(key)) {
</span></span><span style="display:flex;"><span>        queryWrapper.<span style="color:#658b00">and</span>(qw -&gt; {
</span></span><span style="display:flex;"><span>            qw.<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;attr_id&#34;</span>, key).<span style="color:#658b00">or</span>().<span style="color:#658b00">like</span>(<span style="color:#cd5555">&#34;attr_name&#34;</span>, key);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    IPage&lt;AttrEntity&gt; page = <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">page</span>(<span style="color:#8b008b;font-weight:bold">new</span> Query&lt;AttrEntity&gt;().<span style="color:#658b00">getPage</span>(params),
</span></span><span style="display:flex;"><span>            queryWrapper);
</span></span><span style="display:flex;"><span>    PageUtils pageUtils = <span style="color:#8b008b;font-weight:bold">new</span> PageUtils(page);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> pageUtils;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p>修復前端頁面一個小bug，在attr-add-or-update.vue</p>
<ul>
<li>
<p>首先他dataForm.attrId ? &lsquo;新增&rsquo; : &lsquo;修改&rsquo;&ldquo;本來綁的是.id，顯然錯誤(另一個也是這樣)，修改時沒有正確顯示標題</p>
</li>
<li>
<p>另外就是下面開關的，valueType是String類型，結果綁了冒號就怪怪的，點修改時不會動態跟隨傳過去的&quot;1&quot;或&quot;0&quot;而改變</p>
</li>
<li>
<p>而且這個順序不對連文字顏色都會怪怪的</p>
</li>
</ul>
</li>
</ul>
<p><img src="image-20220115235612508.png" alt="image-20220115235612508"></p>
<h4 id="保存">保存</h4>
<ul>
<li>API:</li>
</ul>
<p><img src="image-20220116004605824.png" alt="image-20220116004605824"></p>
<ul>
<li>AttrGroupController.java
<ul>
<li><code>@RequestBody</code>不僅能裝成<code>[]</code>也可以直接裝到<code>List&lt;&gt;</code></li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * 新增保存
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@RequestMapping</span>(<span style="color:#cd5555">&#34;/attr/relation&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#228b22">//@RequiresPermissions(&#34;product:attrgroup:save&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">addAttrGroupRelation</span>(<span style="color:#707a7c">@RequestBody</span> List&lt;AttrGroupRelationVo&gt; vos) {
</span></span><span style="display:flex;"><span>    relationService.<span style="color:#658b00">addAttrGroupRelation</span>(vos);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>AttrAttrgroupRelationServiceImpl.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">addAttrGroupRelation</span>(List&lt;AttrGroupRelationVo&gt; vos) {
</span></span><span style="display:flex;"><span>    List&lt;AttrAttrgroupRelationEntity&gt; collect = vos.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(e -&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 一樣，轉存
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        AttrAttrgroupRelationEntity relationEntity = <span style="color:#8b008b;font-weight:bold">new</span> AttrAttrgroupRelationEntity();
</span></span><span style="display:flex;"><span>        BeanUtils.<span style="color:#658b00">copyProperties</span>(e, relationEntity);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> relationEntity;
</span></span><span style="display:flex;"><span>    }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 調用原生批量保存
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">saveBatch</span>(collect);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>修改前面queryBaseAttrPage方法</li>
</ul>
<p><img src="image-20220116145735332.png" alt="image-20220116145735332"></p>
<ul>
<li>還有保存關聯關係的</li>
</ul>
<p><img src="image-20220116145858040.png" alt="image-20220116145858040"></p>
<h3 id="刪除屬性時刪除關聯">刪除屬性時刪除關聯</h3>
<ul>
<li>
<p>有個漏洞，屬性被刪掉之後pms_attr_attrgroup_relation中的attr_id卻沒刪，雖然不會導致錯誤但會讓表中存在廢物資料</p>
</li>
<li>
<p>嘗試自己完善功能，AttrController.java</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * 刪除
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@RequestMapping</span>(<span style="color:#cd5555">&#34;/delete&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#228b22">//@RequiresPermissions(&#34;product:attr:delete&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">delete</span>(<span style="color:#707a7c">@RequestBody</span> Long[] attrIds) {
</span></span><span style="display:flex;"><span>    attrService.<span style="color:#658b00">removeAttrAndRelationByIds</span>(Arrays.<span style="color:#658b00">asList</span>(attrIds));
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>AttrServiceImpl.java
<ul>
<li>結果第一次做又中了空指針，記住這些<code>xxDao.select</code>一但查了就不會是null，而是可能返回內容為空的List</li>
<li>要用<strong>長度判斷</strong>，切記切記</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">removeAttrAndRelationByIds</span>(List&lt;Long&gt; asList) {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">removeByIds</span>(asList);
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 還要移除關聯
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;AttrAttrgroupRelationEntity&gt; entities =
</span></span><span style="display:flex;"><span>            relationDao.<span style="color:#658b00">selectList</span>(<span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;AttrAttrgroupRelationEntity&gt;().<span style="color:#658b00">in</span>(<span style="color:#cd5555">&#34;attr_id&#34;</span>, asList));
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (entities != <span style="color:#8b008b;font-weight:bold">null</span> &amp;&amp; entities.<span style="color:#658b00">size</span>() &gt; 0) {
</span></span><span style="display:flex;"><span>        relationDao.<span style="color:#658b00">batchDelete</span>(entities);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h2 id="新增商品頁面">新增商品頁面</h2>
<blockquote>
<p>先處裡新增時需要找到該品項相關資訊的API</p>
</blockquote>
<p><img src="image-20220117132244175.png" alt="image-20220117132244175"></p>
<ul>
<li>新增商品需要獲取會員等級，<code>/api/member/memberlevel/</code></li>
<li>先到會員模組調整網關，增加member_route規則</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#bbb">        </span>- <span style="color:#8b008b;font-weight:bold">id</span>:<span style="color:#bbb"> </span>member_route<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#8b008b;font-weight:bold">uri</span>:<span style="color:#bbb"> </span>lb://member<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#8b008b;font-weight:bold">predicates</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- Path=/api/member/**<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#8b008b;font-weight:bold">filters</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- RewritePath=/api/(?&lt;segment&gt;.*),/$\{segment}<span style="color:#bbb">
</span></span></span></code></pre></div><ul>
<li>會員模組的操作大部分比較單純，內建生成的暫時夠用</li>
<li>隨便新增兩個會員等級</li>
</ul>
<p><img src="image-20220117142225484.png" alt="image-20220117142225484"></p>
<h3 id="根據分類返回關聯的品牌">根據分類返回關聯的品牌</h3>
<ul>
<li>API:</li>
</ul>
<p><img src="image-20220117001707359.png" alt="image-20220117001707359"></p>
<ul>
<li>返回的data很簡單，造一個Vo節省流量
<ul>
<li>BrandVo.java</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">BrandVo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> Long brandId;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> String brandName;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>CategoryBrandRelationController.java
<ul>
<li>Controller用來處理請求、檢驗資料、封裝</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * 根據catId返回關聯的品牌
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@GetMapping</span>(<span style="color:#cd5555">&#34;/brands/list&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">list</span>(<span style="color:#707a7c">@RequestParam</span>(<span style="color:#cd5555">&#34;catId&#34;</span>) Long catId) {
</span></span><span style="display:flex;"><span>    List&lt;BrandEntity&gt; vos = categoryBrandRelationService.<span style="color:#658b00">getBrandsByCatId</span>(catId);
</span></span><span style="display:flex;"><span>    List&lt;BrandVo&gt; list = vos.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(e -&gt; {
</span></span><span style="display:flex;"><span>        BrandVo brandVo = <span style="color:#8b008b;font-weight:bold">new</span> BrandVo();
</span></span><span style="display:flex;"><span>        brandVo.<span style="color:#658b00">setBrandId</span>(e.<span style="color:#658b00">getBrandId</span>);
</span></span><span style="display:flex;"><span>        brandVo.<span style="color:#658b00">setBrandName</span>(e.<span style="color:#658b00">getBrandName</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> brandVo;
</span></span><span style="display:flex;"><span>    }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>().<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;data&#34;</span>, list);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>CategoryBrandRelationServiceImpl.java
<ul>
<li>Service層寫業務邏輯，這邊雖然看起來白繞圈還循環查表，但卻是為了維護性與擴展性考量，多學習老師的思路總是好的</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> List&lt;BrandEntity&gt; <span style="color:#008b45">getBrandsByCatId</span>(Long catId) {
</span></span><span style="display:flex;"><span>    List&lt;CategoryBrandRelationEntity&gt; relationEntities =
</span></span><span style="display:flex;"><span>            baseMapper.<span style="color:#658b00">selectList</span>(<span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;CategoryBrandRelationEntity&gt;().<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;catelog_id&#34;</span>, catId));
</span></span><span style="display:flex;"><span>    List&lt;BrandEntity&gt; collect = relationEntities.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(e -&gt; {
</span></span><span style="display:flex;"><span>        Long brandId = e.<span style="color:#658b00">getBrandId</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 調用Service而非DAO，因為DAO是生成的最好寫死的
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">return</span> brandService.<span style="color:#658b00">getById</span>(brandId);
</span></span><span style="display:flex;"><span>    }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> collect;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="獲取規格參數">獲取規格參數</h3>
<ul>
<li>API:</li>
</ul>
<p><img src="image-20220117131731335.png" alt="image-20220117131731335"></p>
<ul>
<li>要返回的是AttrGroup且裡面包含組內的屬性</li>
</ul>
<pre tabindex="0"><code>	&#34;data&#34;: [{
		&#34;attrGroupId&#34;: 1,
		&#34;attrGroupName&#34;: &#34;主体&#34;,
		&#34;sort&#34;: 0,
		&#34;descript&#34;: &#34;主体&#34;,
		&#34;icon&#34;: &#34;dd&#34;,
		&#34;catelogId&#34;: 225,
		&#34;attrs&#34;: [{
			&#34;attrId&#34;: 7,
			&#34;attrName&#34;: &#34;入网型号&#34;,
			&#34;searchType&#34;: 1,
			&#34;valueType&#34;: 0,
			&#34;icon&#34;: &#34;xxx&#34;,
			&#34;valueSelect&#34;: &#34;aaa;bb&#34;,
			&#34;attrType&#34;: 1,
			&#34;enable&#34;: 1,
			&#34;catelogId&#34;: 225,
			&#34;showDesc&#34;: 1,
			&#34;attrGroupId&#34;: null
			}, {
			...
		},
		{
		&#34;attrGroupId&#34;: 2,
		...
</code></pre><ul>
<li>造一個VO</li>
</ul>
<p><img src="image-20220117132943244.png" alt="image-20220117132943244"></p>
<ul>
<li>AttrGroupController.java
<ul>
<li>參數本身在URL的<code>/~/</code>中用<code>@PathVariable</code></li>
<li>在<code>?</code>號後面的用<code>@RequestParam</code></li>
<li>控制層方法名取&quot;想要返回的東西&rdquo;</li>
<li>服務層方法名後面再加上&quot;傳入的參數&quot;</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * 新增商品獲取規格參數
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@GetMapping</span>(<span style="color:#cd5555">&#34;/{catelogId}/withattr&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">getAttrGroupWithAttrs</span>(<span style="color:#707a7c">@PathVariable</span>(<span style="color:#cd5555">&#34;catelogId&#34;</span>) Long catelogId) {
</span></span><span style="display:flex;"><span>    List&lt;AttrGroupWithAttrsVo&gt; vos = attrGroupService.<span style="color:#658b00">getAttrGroupWithAttrsByCatelogId</span>(catelogId);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>().<span style="color:#658b00">put</span>(<span style="color:#cd5555">&#34;data&#34;</span>, vos);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>AttrGroupServiceImpl.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> List&lt;AttrGroupWithAttrsVo&gt; <span style="color:#008b45">getAttrGroupWithAttrsByCatelogId</span>(Long catelogId) {
</span></span><span style="display:flex;"><span>    List&lt;AttrGroupEntity&gt; attrGroupEntities = <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">list</span>(<span style="color:#8b008b;font-weight:bold">new</span> QueryWrapper&lt;AttrGroupEntity&gt;().<span style="color:#658b00">eq</span>(<span style="color:#cd5555">&#34;catelog_id&#34;</span>,
</span></span><span style="display:flex;"><span>            catelogId));
</span></span><span style="display:flex;"><span>    List&lt;AttrGroupWithAttrsVo&gt; collect = attrGroupEntities.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(e -&gt; {
</span></span><span style="display:flex;"><span>        AttrGroupWithAttrsVo attrGroupWithAttrsVo = <span style="color:#8b008b;font-weight:bold">new</span> AttrGroupWithAttrsVo();
</span></span><span style="display:flex;"><span>        BeanUtils.<span style="color:#658b00">copyProperties</span>(e, attrGroupWithAttrsVo);
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 獲取attrs，用之前寫過的方法從分組ID就能找到
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        List&lt;AttrEntity&gt; attrEntityList = attrService.<span style="color:#658b00">getAttrRelation</span>(e.<span style="color:#658b00">getAttrGroupId</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 裝進VO
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        attrGroupWithAttrsVo.<span style="color:#658b00">setAttrs</span>(attrEntityList);
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> attrGroupWithAttrsVo;
</span></span><span style="display:flex;"><span>    }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> collect;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>回前端補一個非空判斷</li>
</ul>
<p><img src="image-20220117140603784.png" alt="image-20220117140603784"></p>
<ul>
<li>成功，話說這個前端頁面還蠻屌的，可選項沒有甚至還能現加，還好教材做了不然自己來肯定又要搞半天</li>
</ul>
<p><img src="image-20220117141026751.png" alt="image-20220117141026751"></p>
<ul>
<li>後面兩步都沒問題，前端頁面都做好了，會根據銷售屬性算出笛卡爾積，可以詳細針對每個SKU做設定</li>
</ul>
<p><img src="image-20220117160514657.png" alt="image-20220117160514657"></p>
<ul>
<li>點選發佈，會產生一串很長的JSON，接下來就到保存了</li>
</ul>
<h1 id="保存商品">保存商品</h1>
<ul>
<li>保存商品要調用商品模組、會員模組，不僅要跨模組，還涉及非常多張表，只能一點一點拆開來做了</li>
</ul>
<p><img src="image-20220117163355499.png" alt="image-20220117163355499"></p>
<h3 id="從json生成pojo">從JSON生成POJO</h3>
<blockquote>
<p>顯然自己手動造VO太累了，有更快的方法</p>
</blockquote>
<ul>
<li>API:</li>
</ul>
<p><img src="image-20220117155719059.png" alt="image-20220117155719059"></p>
<ul>
<li>把API文檔直接丟給插件解析，我使用插件RoboPOJOGenerator</li>
</ul>
<p><img src="image-20220117155850409.png" alt="image-20220117155850409"></p>
<ul>
<li>選框架、命名，自動生成POJO</li>
</ul>
<p><img src="image-20220117160200428.png" alt="image-20220117160200428"></p>
<ul>
<li>但是要注意生成的數字類型，如果是金錢等要求精度的，手動換成<code>BigDecimal</code></li>
<li>並且資料庫中都是Long類型，把相關的Int也都換掉</li>
</ul>
<h3 id="開始保存">開始保存</h3>
<ul>
<li>SpuInfoController.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#228b22">/**
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> * 保存SpuSaveVo
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@RequestMapping</span>(<span style="color:#cd5555">&#34;/save&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> R <span style="color:#008b45">save</span>(<span style="color:#707a7c">@RequestBody</span> SpuSaveVo vo) {
</span></span><span style="display:flex;"><span>    spuInfoService.<span style="color:#658b00">saveSpuInfo</span>(vo);
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">return</span> R.<span style="color:#658b00">ok</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>SpuInfoServiceImpl.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Transactional</span>(rollbackFor = Exception.<span style="color:#658b00">class</span>)
</span></span><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">saveSpuInfo</span>(SpuSaveVo vo) {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 1、保存spu基本信息：pms_spu_info
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    SpuInfoEntity spuInfoEntity = <span style="color:#8b008b;font-weight:bold">new</span> SpuInfoEntity();
</span></span><span style="display:flex;"><span>    BeanUtils.<span style="color:#658b00">copyProperties</span>(vo, spuInfoEntity);
</span></span><span style="display:flex;"><span>    spuInfoEntity.<span style="color:#658b00">setCreateTime</span>(<span style="color:#8b008b;font-weight:bold">new</span> Date());
</span></span><span style="display:flex;"><span>    spuInfoEntity.<span style="color:#658b00">setUpdateTime</span>(<span style="color:#8b008b;font-weight:bold">new</span> Date());
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">save</span>(spuInfoEntity);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 2、保存spu的描述圖片：pms_spu_info_desc
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#228b22">// 這個decript錯字來自前端...算了就照它的吧
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;String&gt; decript = vo.<span style="color:#658b00">getDecript</span>();
</span></span><span style="display:flex;"><span>    SpuInfoDescEntity spuInfoDescEntity = <span style="color:#8b008b;font-weight:bold">new</span> SpuInfoDescEntity();
</span></span><span style="display:flex;"><span>    spuInfoDescEntity.<span style="color:#658b00">setSpuId</span>(spuInfoEntity.<span style="color:#658b00">getId</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 用逗號分隔多張描述圖片，描述圖片就是購物時左上那些摸過去會放大的小圖
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#228b22">// String.join方法可以自動遍歷數組中的String然後拼接成一個String
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    spuInfoDescEntity.<span style="color:#658b00">setDecript</span>(String.<span style="color:#658b00">join</span>(<span style="color:#cd5555">&#34;,&#34;</span>, decript));
</span></span><span style="display:flex;"><span>    spuInfoDescService.<span style="color:#658b00">save</span>(spuInfoDescEntity);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 3、保存spu的圖片集：pms_spu_images，
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#228b22">// 圖片集就是往下拉，在頁面中央出現的多張商品宣傳大圖
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;String&gt; images = vo.<span style="color:#658b00">getImages</span>();
</span></span><span style="display:flex;"><span>    spuImagesService.<span style="color:#658b00">saveImages</span>(spuInfoEntity.<span style="color:#658b00">getId</span>(), images);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 4、保存spu的規格參數：pms_product_attr_value
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;BaseAttrsItem&gt; baseAttrs = vo.<span style="color:#658b00">getBaseAttrs</span>();
</span></span><span style="display:flex;"><span>    List&lt;ProductAttrValueEntity&gt; collect = baseAttrs.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(attr -&gt; {
</span></span><span style="display:flex;"><span>        ProductAttrValueEntity valueEntity = <span style="color:#8b008b;font-weight:bold">new</span> ProductAttrValueEntity();
</span></span><span style="display:flex;"><span>        valueEntity.<span style="color:#658b00">setAttrId</span>(attr.<span style="color:#658b00">getAttrId</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 查詢attr屬性名
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        AttrEntity byId = attrService.<span style="color:#658b00">getById</span>(attr.<span style="color:#658b00">getAttrId</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        valueEntity.<span style="color:#658b00">setAttrName</span>(byId.<span style="color:#658b00">getAttrName</span>());
</span></span><span style="display:flex;"><span>        valueEntity.<span style="color:#658b00">setAttrValue</span>(attr.<span style="color:#658b00">getAttrValues</span>());
</span></span><span style="display:flex;"><span>        valueEntity.<span style="color:#658b00">setQuickShow</span>(attr.<span style="color:#658b00">getShowDesc</span>());
</span></span><span style="display:flex;"><span>        valueEntity.<span style="color:#658b00">setSpuId</span>(spuInfoEntity.<span style="color:#658b00">getId</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">return</span> valueEntity;
</span></span><span style="display:flex;"><span>    }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>    productAttrValueService.<span style="color:#658b00">saveBatch</span>(collect);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 6、保存spu的積分信息：gulimall_sms---&gt;sms_spu_bounds
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    Bounds bounds = vo.<span style="color:#658b00">getBounds</span>();
</span></span><span style="display:flex;"><span>    SpuBoundsTo spuBoundsTo = <span style="color:#8b008b;font-weight:bold">new</span> SpuBoundsTo();
</span></span><span style="display:flex;"><span>    BeanUtils.<span style="color:#658b00">copyProperties</span>(bounds, spuBoundsTo);
</span></span><span style="display:flex;"><span>    spuBoundsTo.<span style="color:#658b00">setSpuId</span>(spuInfoEntity.<span style="color:#658b00">getId</span>());
</span></span><span style="display:flex;"><span>    R r = couponFeignService.<span style="color:#658b00">saveSpuBounds</span>(spuBoundsTo);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (r.<span style="color:#658b00">getCode</span>() != 0) {
</span></span><span style="display:flex;"><span>        log.<span style="color:#658b00">error</span>(<span style="color:#cd5555">&#34;遠程保存spu積分失敗&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 5、保存當前spu對應的所有sku信息：pms_sku_info
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    List&lt;SkusItem&gt; skus = vo.<span style="color:#658b00">getSkus</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (skus != <span style="color:#8b008b;font-weight:bold">null</span> &amp;&amp; skus.<span style="color:#658b00">size</span>() &gt; 0) {
</span></span><span style="display:flex;"><span>        skus.<span style="color:#658b00">forEach</span>(item -&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 傳來的是多個skus，遍歷一個一個處理
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 5、1）、sku的基本信息:pms_sku_info
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">// 如果有設定預設圖片
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            String defaultImg = <span style="color:#cd5555">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">for</span> (ImagesItem image : item.<span style="color:#658b00">getImages</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">if</span> (image.<span style="color:#658b00">getDefaultImg</span>() == 1) {
</span></span><span style="display:flex;"><span>                    defaultImg = image.<span style="color:#658b00">getImgUrl</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 準備存到pms_sku_info表
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            SkuInfoEntity skuInfoEntity = <span style="color:#8b008b;font-weight:bold">new</span> SkuInfoEntity();
</span></span><span style="display:flex;"><span>            BeanUtils.<span style="color:#658b00">copyProperties</span>(item, skuInfoEntity);
</span></span><span style="display:flex;"><span>            skuInfoEntity.<span style="color:#658b00">setBrandId</span>(spuInfoEntity.<span style="color:#658b00">getBrandId</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 資料庫中又是這個錯字CatalogId，之前被坑好久
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            skuInfoEntity.<span style="color:#658b00">setCatalogId</span>(spuInfoEntity.<span style="color:#658b00">getCatalogId</span>());
</span></span><span style="display:flex;"><span>            skuInfoEntity.<span style="color:#658b00">setSaleCount</span>(0L);
</span></span><span style="display:flex;"><span>            skuInfoEntity.<span style="color:#658b00">setSpuId</span>(spuInfoEntity.<span style="color:#658b00">getId</span>());
</span></span><span style="display:flex;"><span>            skuInfoEntity.<span style="color:#658b00">setSkuDefaultImg</span>(defaultImg);
</span></span><span style="display:flex;"><span>            skuInfoService.<span style="color:#658b00">save</span>(skuInfoEntity);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            Long skuId = skuInfoEntity.<span style="color:#658b00">getSkuId</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 5、2）、sku的圖片信息：pms_sku_images，這張表中的條目是基於skuId
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">// 因為一個skuId可以有多張圖片
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            List&lt;SkuImagesEntity&gt; imagesEntities = item.<span style="color:#658b00">getImages</span>().<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(img -&gt; {
</span></span><span style="display:flex;"><span>                SkuImagesEntity skuImagesEntity = <span style="color:#8b008b;font-weight:bold">new</span> SkuImagesEntity();
</span></span><span style="display:flex;"><span>                skuImagesEntity.<span style="color:#658b00">setSkuId</span>(skuId);
</span></span><span style="display:flex;"><span>                skuImagesEntity.<span style="color:#658b00">setImgUrl</span>(img.<span style="color:#658b00">getImgUrl</span>());
</span></span><span style="display:flex;"><span>                skuImagesEntity.<span style="color:#658b00">setDefaultImg</span>(img.<span style="color:#658b00">getDefaultImg</span>());
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">return</span> skuImagesEntity;
</span></span><span style="display:flex;"><span>            }).<span style="color:#658b00">filter</span>(entity -&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#228b22">// filter返回true就是需要留下的，false就是剔除的
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>                <span style="color:#8b008b;font-weight:bold">return</span> !StringUtils.<span style="color:#658b00">isEmpty</span>(entity.<span style="color:#658b00">getImgUrl</span>());
</span></span><span style="display:flex;"><span>            }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 批量保存到pms_sku_images
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            skuImagesService.<span style="color:#658b00">saveBatch</span>(imagesEntities);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 5、3）、sku的銷售屬性：pms_sku_sale_attr_value
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">// 就是因為銷售屬性的笛卡爾積導致有多個sku，這張表保存了某個skuId對應的屬性具體是啥值
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#228b22">// 例如顏色是黑色，RAM是8G
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            List&lt;AttrItem&gt; attr = item.<span style="color:#658b00">getAttr</span>();
</span></span><span style="display:flex;"><span>            List&lt;SkuSaleAttrValueEntity&gt; skuSaleAttrValueEntities = attr.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(a -&gt; {
</span></span><span style="display:flex;"><span>                SkuSaleAttrValueEntity skuSaleAttrValueEntity = <span style="color:#8b008b;font-weight:bold">new</span> SkuSaleAttrValueEntity();
</span></span><span style="display:flex;"><span>                BeanUtils.<span style="color:#658b00">copyProperties</span>(a, skuSaleAttrValueEntity);
</span></span><span style="display:flex;"><span>                skuSaleAttrValueEntity.<span style="color:#658b00">setSkuId</span>(skuId);
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">return</span> skuSaleAttrValueEntity;
</span></span><span style="display:flex;"><span>            }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 批量保存到pms_sku_sale_attr_value
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            skuSaleAttrValueService.<span style="color:#658b00">saveBatch</span>(skuSaleAttrValueEntities);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 5、4）、sku的優惠、滿減等信息：gulimall_sms---&gt;sms_sku_ladder、sms_sku_full_reduction、sms_member_price
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            SkuReductionTo skuReductionTo = <span style="color:#8b008b;font-weight:bold">new</span> SkuReductionTo();
</span></span><span style="display:flex;"><span>            BeanUtils.<span style="color:#658b00">copyProperties</span>(item, skuReductionTo);
</span></span><span style="display:flex;"><span>            skuReductionTo.<span style="color:#658b00">setSkuId</span>(skuId);
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 有設定打折規則再保存，省得資料庫中存一堆0
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            <span style="color:#8b008b;font-weight:bold">if</span> (skuReductionTo.<span style="color:#658b00">getFullCount</span>() &gt; 0 || skuReductionTo.<span style="color:#658b00">getFullPrice</span>().<span style="color:#658b00">compareTo</span>(BigDecimal.<span style="color:#658b00">ZERO</span>) == 1) {
</span></span><span style="display:flex;"><span>                R r1 = couponFeignService.<span style="color:#658b00">saveSkuReduction</span>(skuReductionTo);
</span></span><span style="display:flex;"><span>                <span style="color:#8b008b;font-weight:bold">if</span> (r1.<span style="color:#658b00">getCode</span>() != 0) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#658b00">error</span>(<span style="color:#cd5555">&#34;遠程保存sku優惠資訊失敗&#34;</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><ul>
<li>SpuImagesServiceImpl.java
<ul>
<li>saveImages方法是每張圖片有自己的一個<code>SpuImagesEntity</code></li>
</ul>
</li>
</ul>
<p><img src="image-20220117170242122.png" alt="image-20220117170242122"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">saveImages</span>(Long id, List&lt;String&gt; images) {
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">if</span> (images != <span style="color:#8b008b;font-weight:bold">null</span> &amp;&amp; images.<span style="color:#658b00">size</span>() &gt; 0) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 要存成多條紀錄
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        List&lt;SpuImagesEntity&gt; collect = images.<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(e -&gt; {
</span></span><span style="display:flex;"><span>            SpuImagesEntity spuImagesEntity = <span style="color:#8b008b;font-weight:bold">new</span> SpuImagesEntity();
</span></span><span style="display:flex;"><span>            spuImagesEntity.<span style="color:#658b00">setSpuId</span>(id);
</span></span><span style="display:flex;"><span>            spuImagesEntity.<span style="color:#658b00">setImgUrl</span>(e);
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">return</span> spuImagesEntity;
</span></span><span style="display:flex;"><span>        }).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">saveBatch</span>(collect);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="遠程調用feign">遠程調用feign</h3>
<p>複習一下步驟:</p>
<ul>
<li>導依賴spring-cloud-starter-openfeign</li>
<li>在common模組造feign包，包下放接口
<ul>
<li>接口上註解<code>@FeignClient(&quot;要被調用的服務名&quot;)</code></li>
<li>把要被調用的方法完整URL寫上(可以去目標controller直接偷)</li>
<li>範例: CouponFeignService.java</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@FeignClient</span>(<span style="color:#cd5555">&#34;coupon&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">interface</span> <span style="color:#008b45;font-weight:bold">CouponFeignService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 上傳商品時，保存 遠程調用的積分訊息
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#707a7c">@PostMapping</span>(<span style="color:#cd5555">&#34;/coupon/spubounds/save&#34;</span>)
</span></span><span style="display:flex;"><span>    R <span style="color:#008b45">saveSpuBounds</span>(<span style="color:#707a7c">@RequestBody</span> SpuBoundsTo spuBoundsTo);
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 相當於 R save(@RequestBody SpuBoundsEntity spuBounds)
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#228b22">// 因為都是轉成JSON在傳送，轉回來屬性能對上就行
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 上傳商品時，保存 遠程調用的滿減、會員優惠訊息
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#707a7c">@PostMapping</span>(<span style="color:#cd5555">&#34;/coupon/skufullreduction/saveinfo&#34;</span>)
</span></span><span style="display:flex;"><span>    R <span style="color:#008b45">saveSkuReduction</span>(<span style="color:#707a7c">@RequestBody</span> SkuReductionTo skuReductionTo);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>回到要調用別人的啟動類，註解掃描<code>.common.feign</code>包</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@EnableFeignClients</span>(basePackages = <span style="color:#cd5555">&#34;yozi.mall.common.feign&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">ProductApplication</span> {
</span></span></code></pre></div><h4 id="to類">To類</h4>
<blockquote>
<p>Transfer Object</p>
</blockquote>
<ul>
<li>通常放在common模組下</li>
<li>用於服務間傳遞物件，例如: SkuReductionTo.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#8b008b;font-weight:bold">class</span> <span style="color:#008b45;font-weight:bold">SkuReductionTo</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> Long skuId;
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 打幾折
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">private</span> BigDecimal discount;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> Integer priceStatus;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> BigDecimal fullPrice;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> BigDecimal reducePrice;
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> Integer countStatus;
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// 滿幾件
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">private</span> Integer fullCount;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">private</span> List&lt;MemberPriceItem&gt; memberPrice;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>其實feign是轉成JSON在傳送，轉回來屬性能對上就行</li>
<li>但是要注意JSON轉化的規則，有時候不同依賴提供的JSON編碼有細小差異可能就會造成BUG</li>
<li>這邊總共遠程調用了2個服務，第一個spu積分沒啥特別的，直接灌給生成的save方法就好</li>
<li>第二個sku的滿減、會員優惠就很坑了，因為To中的屬性與目標地要保存的Entity有些對不上，於是才要自創saveInfo方法</li>
<li>SkuFullReductionServiceImpl.java
<ul>
<li>善用快速產生setter的插件</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#707a7c">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8b008b;font-weight:bold">public</span> <span style="color:#00688b;font-weight:bold">void</span> <span style="color:#008b45">saveInfo</span>(SkuReductionTo skuReductionTo) {
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 保存階梯優惠
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (skuReductionTo.<span style="color:#658b00">getFullCount</span>() &gt; 0) {
</span></span><span style="display:flex;"><span>            SkuLadderEntity skuLadderEntity = <span style="color:#8b008b;font-weight:bold">new</span> SkuLadderEntity();
</span></span><span style="display:flex;"><span>            skuLadderEntity.<span style="color:#658b00">setSkuId</span>(skuReductionTo.<span style="color:#658b00">getSkuId</span>());
</span></span><span style="display:flex;"><span>            skuLadderEntity.<span style="color:#658b00">setFullCount</span>(skuReductionTo.<span style="color:#658b00">getFullCount</span>());
</span></span><span style="display:flex;"><span>            skuLadderEntity.<span style="color:#658b00">setDiscount</span>(skuReductionTo.<span style="color:#658b00">getDiscount</span>());
</span></span><span style="display:flex;"><span>            skuLadderEntity.<span style="color:#658b00">setAddOther</span>(skuReductionTo.<span style="color:#658b00">getCountStatus</span>());
</span></span><span style="display:flex;"><span>            skuLadderService.<span style="color:#658b00">save</span>(skuLadderEntity);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 保存滿減優惠
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        <span style="color:#8b008b;font-weight:bold">if</span> (skuReductionTo.<span style="color:#658b00">getFullPrice</span>().<span style="color:#658b00">compareTo</span>(BigDecimal.<span style="color:#658b00">ZERO</span>) &gt; 0) {
</span></span><span style="display:flex;"><span>            SkuFullReductionEntity fullReductionEntity = <span style="color:#8b008b;font-weight:bold">new</span> SkuFullReductionEntity();
</span></span><span style="display:flex;"><span>            fullReductionEntity.<span style="color:#658b00">setSkuId</span>(skuReductionTo.<span style="color:#658b00">getSkuId</span>());
</span></span><span style="display:flex;"><span>            fullReductionEntity.<span style="color:#658b00">setFullPrice</span>(skuReductionTo.<span style="color:#658b00">getFullPrice</span>());
</span></span><span style="display:flex;"><span>            fullReductionEntity.<span style="color:#658b00">setReducePrice</span>(skuReductionTo.<span style="color:#658b00">getReducePrice</span>());
</span></span><span style="display:flex;"><span>            fullReductionEntity.<span style="color:#658b00">setAddOther</span>(skuReductionTo.<span style="color:#658b00">getCountStatus</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">this</span>.<span style="color:#658b00">save</span>(fullReductionEntity);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#228b22">// 保存會員優惠
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>        List&lt;MemberPriceEntity&gt; collect = skuReductionTo.<span style="color:#658b00">getMemberPrice</span>().<span style="color:#658b00">stream</span>().<span style="color:#658b00">map</span>(e -&gt; {
</span></span><span style="display:flex;"><span>            MemberPriceEntity memberPriceEntity = <span style="color:#8b008b;font-weight:bold">new</span> MemberPriceEntity();
</span></span><span style="display:flex;"><span>            memberPriceEntity.<span style="color:#658b00">setSkuId</span>(skuReductionTo.<span style="color:#658b00">getSkuId</span>());
</span></span><span style="display:flex;"><span>            memberPriceEntity.<span style="color:#658b00">setMemberLevelId</span>(e.<span style="color:#658b00">getId</span>());
</span></span><span style="display:flex;"><span>            memberPriceEntity.<span style="color:#658b00">setMemberLevelName</span>(e.<span style="color:#658b00">getName</span>());
</span></span><span style="display:flex;"><span>            memberPriceEntity.<span style="color:#658b00">setMemberPrice</span>(e.<span style="color:#658b00">getPrice</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#228b22">// 預設可疊加會員優惠
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>            memberPriceEntity.<span style="color:#658b00">setAddOther</span>(1);
</span></span><span style="display:flex;"><span>            <span style="color:#8b008b;font-weight:bold">return</span> memberPriceEntity;
</span></span><span style="display:flex;"><span>        }).<span style="color:#658b00">filter</span>(e -&gt; e.<span style="color:#658b00">getMemberPrice</span>().<span style="color:#658b00">compareTo</span>(BigDecimal.<span style="color:#658b00">ZERO</span>) &gt; 0).<span style="color:#658b00">collect</span>(Collectors.<span style="color:#658b00">toList</span>());
</span></span><span style="display:flex;"><span>        memberPriceService.<span style="color:#658b00">saveBatch</span>(collect);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h3 id="知識點">知識點</h3>
<ul>
<li>
<p>String.join遍歷數組中的String，拼接成一個長的String</p>
</li>
<li>
<p>手動設定id的屬性，非自增要加註解(mybatisPlus預設會自增)</p>
</li>
</ul>
<p><img src="image-20220117213214251.png" alt="image-20220117213214251"></p>
<ul>
<li>在流中使用過濾器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>.<span style="color:#658b00">filter</span>(entity -&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#228b22">// filter返回true就是需要留下的，false就是剔除的
</span></span></span><span style="display:flex;"><span><span style="color:#228b22"></span>    <span style="color:#8b008b;font-weight:bold">return</span> !StringUtils.<span style="color:#658b00">isEmpty</span>(entity.<span style="color:#658b00">getImgUrl</span>());
</span></span></code></pre></div><ul>
<li>BigDecimal的比較與判斷
<ul>
<li>A.compareTo(B)，返回1表示A比B大，返回0表示相等，返回-1表示A比B小</li>
<li>判斷BigDecimal xxx是否&gt; 0 :</li>
<li>幹對阿==1不就 &gt; 0，直接用&gt;0還比較好讀</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>xxx.<span style="color:#658b00">compareTo</span>(BigDecimal.<span style="color:#658b00">ZERO</span>) == 1 或 &gt; 0 
</span></span></code></pre></div><h2 id="debug小技巧">Debug小技巧</h2>
<ul>
<li>快速導出HTTP請求到postman</li>
</ul>
<p><img src="image-20220117215243371.png" alt="image-20220117215243371"></p>
<ul>
<li>縮減F12不需要顯示的區塊</li>
</ul>
<p><img src="image-20220118162128763.png" alt="image-20220118162128763"></p>
<ul>
<li>讓mybatis-plus輸出log到控制台，application.properties</li>
</ul>
<pre tabindex="0"><code>mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
</code></pre><ul>
<li>Compound批次啟動服務</li>
</ul>
<p><img src="image-20220117212630739.png" alt="image-20220117212630739"></p>
<ul>
<li>-Xmx設定最大占用記憶體</li>
</ul>
<p><img src="image-20220117212736437.png" alt="image-20220117212736437"></p>
<ul>
<li>設置斷點
<ul>
<li>要查看的物件直接點灰字可以展開詳細</li>
</ul>
</li>
</ul>
<p><img src="image-20220117220041272.png" alt="image-20220117220041272"></p>
<ul>
<li>使用F8下一步，或設好下一個斷點直接按左下的快進(F9)</li>
</ul>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">上次修改於 2022-01-23</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://yoziming.github.io/post/220123-array-list-polymorphism/">
			下一篇<br>array、list多型與BaseMapper之謎
                </a>
                
                
                
                <a class="older-posts" href="https://yoziming.github.io/post/220122-java-try-finally-return/">
			上一篇<br>Java中finally與return的順序
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                








<div id="waline"></div>
<script>
    new Waline({
        el: '#waline',
        path: location.pathname,
        serverURL: "https://waline-pn38gfwbz-yoziming.vercel.app/" ,
		lang: 'en-US',
		visitor: true,
		meta: ['nick', 'mail'],
    });
    </script>



            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	Yoziming
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
